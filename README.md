# farabi-mock (Private Repo Example)

This repository shows how to host a static patient management UI on Cloudflare Pages while keeping your data private in a GitHub repository.  A Cloudflare Worker acts as a secure proxy between the web UI and a GitHub Actions workflow.  When a user adds a service to a patient record via the UI, the Worker triggers a manual workflow (`apply_change.yml`) that appends the service to `data/patients-with-services.csv` and records the operation in `AUTOMATION-PROJECT/changes_YYYY-MM-DD.jsonl`.

## Repository structure

- **site/** – Static files for the UI.  `records.html` includes a simple search form and service table for each patient.  `data.js` embeds all patient data as a JavaScript object.  `app.js` implements the search logic and sends add‑service requests to your Cloudflare Worker.
- **data/** – CSV files containing your patient information.  Only `patients-with-services.csv` is modified by the workflow; the other CSV files are read‑only.
- **scripts/apply_change.py** – Python script invoked by the workflow to append a service entry and write a log record.  It ensures the CSV header is updated if new fields are introduced.
- **.github/workflows/apply_change.yml** – GitHub Actions workflow triggered manually via the GitHub API.  It installs Python, runs `apply_change.py`, then commits and pushes any changes to `data/patients-with-services.csv` and newly generated log files.
- **AUTOMATION-PROJECT/** – Directory where JSONL log files are written.  Each day’s changes are collected in a file named `changes_YYYY-MM-DD.jsonl`.

## How it works

1. **User interaction:** The user opens `records.html` from your Cloudflare Pages site.  They search for a file number, view the patient’s services, and submit a new service via the form.
2. **Worker API:** `app.js` sends a POST request to your Cloudflare Worker, including the file number, patient name, service details, policy expiry, and optional notes.  The Worker verifies the request (via an API key) and calls the GitHub REST API to dispatch the workflow.
3. **Workflow execution:** GitHub Actions runs `apply_change.py`.  The script updates `patients-with-services.csv` and appends a JSONL log entry to `AUTOMATION-PROJECT/changes_YYYY-MM-DD.jsonl`.  The workflow commits and pushes these changes back to the repository.
4. **Updated data:** The next time the site is built (triggered by the commit), the updated data will be bundled into `data.js`, and the user will see the newly added service.

## Setup steps

1. **Create a private repository named `farabi-mock`** on GitHub and commit this directory structure.
2. **Add a personal access token** with `repo` and `workflow` scopes as a repository secret named `GH_TOKEN` in your GitHub repository settings.
3. **Deploy Cloudflare Pages**:
   - In the Cloudflare dashboard, create a Pages project linked to your private repository.  Cloudflare Pages can build from private repos (it will ask you to authorize access).
   - Set the build output directory to `site`.
4. **Deploy the Cloudflare Worker**:
   - Use the provided Worker code (not included here) and configure the following environment variables in the Worker settings:
     - `GH_TOKEN` – your GitHub token.
     - `GH_OWNER` – `DrRaSHed`.
     - `GH_REPO` – `farabi-mock`.
     - `WORKFLOW_FILE` – `apply_change.yml`.
     - `BRANCH` – `main`.
     - `API_KEY` – a secret string to authorize requests from your UI.
   - Deploy the Worker and note the `.workers.dev` URL.
5. **Configure the UI**:
   - Open `site/app.js` and set `WORKER_URL` to your Worker endpoint.
   - Set `API_KEY` to the same value you configured in the Worker.
6. **Rebuild your Pages site**.  The new UI will call your Worker whenever a service is added.  The workflow will update the CSV and write log records.

## Notes

- GitHub Pages does not support private repositories on the free plan, so this setup uses Cloudflare Pages for hosting while keeping your repository private.
- To avoid exposing your GitHub token in the browser, all calls to the GitHub API are made from the Worker, which stores the token securely in environment variables.
- Commits generated by the workflow will trigger a new build of your Pages site, ensuring the latest data is available.  There is a slight delay (1–3 minutes) while the workflow and build complete
